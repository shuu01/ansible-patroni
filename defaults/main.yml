---
# defaults file for patroni

# patroni variables
patroni_pg_port: 5432
patroni_archive_command: "mkdir -p ../wal_archive && test ! -f ../wal_archive/%f && cp %p ../wal_archive/%f"
patroni_scope: cluster

patroni_rest_username: patroni-username
patroni_rest_password: patroni-password

patroni_dcs: etcd

# postgresql variables (override it with group_vars or host_vars if needed)
postgresql_version: 11

postgresql_apt_key_id: "ACCC4CF8"
postgresql_apt_key_url: "https://www.postgresql.org/media/keys/ACCC4CF8.asc"
postgresql_apt_repository: "deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main"

postgresql_bin: "/usr/lib/postgresql/{{ postgresql_version }}/bin"
postgresql_data: "/var/lib/postgresql/{{ postgresql_version }}/data"

postgresql_superuser_username: postgres
postgresql_superuser_password: superuser-password
postgresql_replication_username: replicator
postgresql_replication_password: "{{ postgresql_superuser_password }}"

postgresql_create_main_cluster: false

patroni_dcs_parameters:
  ttl: 30
  loop_wait: 10
  maximum_lag_on_failover: 1048576 # 1 megabyte in bytes
  synchronous_mode: true # create at least one sync replica

patroni_pg_hba:
  - { type: "host",  database: "all",         user: "all",                                   address: "0.0.0.0/0", method: "md5" }
  - { type: "host",  database: "replication", user: "{{ postgresql_replication_username }}", address: "0.0.0.0/0", method: "md5" }
  - { type: "local", database: "all",         user: "all",                                   address: "",          method: "peer" }

patroni_pg_parameters:
  synchronous_commit: "off"
  synchronous_standby_names: "'*'"
  shared_preload_libraries: "pg_stat_statements"
  archive_mode: "on"
  wal_level: "hot_standby"
  archive_command: "{{ patroni_archive_command }}"
  max_wal_senders: "10"
  wal_keep_segments: "8"
  archive_timeout: "1800s"
  max_replication_slots: "5"
  hot_standby: "on"
  wal_log_hints: "on"

patroni_initdb:
  encoding: UTF8

patroni_pg_create_replica_methods:
  basebackup:
    max-rate: "100M"
# pgbackrest:
# wal_e:

patroni_pg_listen: 0.0.0.0
patroni_pg_connect_address: "{{ ansible_default_ipv4.address }}:{{ patroni_pg_port }}"
patroni_pg_use_unix_socket: false

# etcd variables
etcd_host: 127.0.0.1
etcd_port: 2379
